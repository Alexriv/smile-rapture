{% extends 'layout.html' %}
{% block content %}
    <style>
        .navbar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 20px;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .navbar .nav-title {
            margin-right: auto;
            font-size: 1.5em;
            font-weight: bolder;
        }

        .navbar li {
            list-style: none;
            display: inline-block;
            padding: 0 20px;
        }

        .navbar a {
            text-decoration: none;
            color: #007bff;
            transition: all 0.3s ease 0s;
        }

        .navbar a:hover {
            color: #b2dfdb;
        }

        .node-section,
        .container-section {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .container-section {
            background: #ffffff;
        }

        .node-section {
            background: #f0f0f0;
        }

        .node-section h4 {
            margin-top: 0;
        }

        .file-upload-wrapper {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 20px;
        }

        #addNodeButton,
        .add-container-button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
            display: block;
        }

        #addNodeButton:hover,
        .add-container-button:hover {
            background-color: #0056b3;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .form h2 {
            margin-top: 0;
        }

        .accordion {
            background-color: #dddddd;
            color: #444;
            cursor: pointer;
            padding: 10px;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
            transition: 0.4s;
        }

        .accordion.active,
        .accordion:hover {
            background-color: #cccccc;
        }

        .panel {
            padding: 0 18px;
            background-color: white;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            border-radius: 0 0 5px 5px;
        }

        .panel-inner {
            padding: 20px;
        }

        .remove-icon {
            float: right;
            cursor: pointer;
            font-size: 20px;
            color: #999;
        }

        .remove-icon:hover {
            color: #666;
        }

        input[type="text"],
        input[type="file"],
        select {
            width: auto;
            padding: 10px;
            margin: 5px 0 20px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        input[type="submit"] {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        input[type="submit"]:hover {
            background-color: #0056b3;
        }

        /* Add additional styles as needed */

    </style>
    <form action="/upload_file" method="post" enctype="multipart/form-data">
        <h2>Submit Experiment</h2>
        <p>Logged in as: {{ user.name_id }}</p>

        <!-- Nodes Section -->
        <div id="nodesSection" style="">
            <h3>Nodes</h3>
            <!-- Node Sections will be appended here -->
            <div id="nodeSections"></div>
            <!-- Button to add new node -->
            <button type="button" id="addNodeButton" onclick="addNode()">Add Node</button>
        </div>

        <hr style="margin-top: 20px;margin-bottom: 20px;">
        <div id="submitSection">
            <input type="submit" value="Upload"><br>
        </div>
    </form>

    <script>
        let nodeCount = 0;
        let containerCounts = {};

        function addNode() {
            nodeCount++;  // Increment the node counter
            containerCounts[nodeCount] = 0;  // Initialize container counter for this node
            createNodeSection(nodeCount);
        }

        function createNodeSection(nodeNumber) {
            const node = document.createElement('div');
            node.classList.add('node-section');
            node.id = `node-${nodeNumber}`;
            node.innerHTML = `
        <h4>Node ${nodeNumber}</h4>
        <div>
            <label for="node-type-${nodeNumber}">Node Type:</label>
            <select id="node-type-${nodeNumber}" name="node-type-${nodeNumber}">
                {% for type in node_types %}
                    <option value="{{ type }}">{{ type }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="containers" id="containers-node-${nodeNumber}"></div>
        <button type="button" onclick="addContainerToNode(${nodeNumber})">Add Container</button>
    `;

            const nodeSections = document.getElementById('nodeSections');
            nodeSections.appendChild(node);

            // Automatically add one container to the new node
            addContainerToNode(nodeNumber);
        }

        function addContainerToNode(nodeNumber) {
            containerCounts[nodeNumber]++;  // Increment container counter for this node
            const containerNumber = containerCounts[nodeNumber];
            const containerId = `node-${nodeNumber}-container-${containerNumber}`;

            const containerSection = document.createElement('div');
            containerSection.classList.add('container-section');
            containerSection.id = containerId;
            containerSection.innerHTML = `
                <span class="remove-icon" onclick="removeContainerSection(this, ${nodeNumber})">&#10006;</span>
                <h4>Container ${containerNumber}</h4>
                <div class="container-details">
                    <label for="container-image-${nodeNumber}">Container Image:</label>
                    <select id="container-image-${nodeNumber}" name="container-image-${nodeNumber}[]">
                        {% for img in valid_images %}
                            <option value="{{ img }}">{{ img }}</option>
                        {% endfor %}
                    </select>

                    <div class="file-upload-wrapper">
                        <label for="code-files-${nodeNumber}">source.zip: </label>
                        <input type="file" id="code-files-${nodeNumber}" name="code-files-${nodeNumber}[]" accept=".zip">
                    </div>

                    <div class="file-upload-wrapper">
                        <label for="req-files-${nodeNumber}">requirements.txt: </label>
                        <input type="file" id="req-files-${nodeNumber}" name="req-files-${nodeNumber}[]">
                    </div>

                    <label for="ports-open-${nodeNumber}">Open Ports (comma-separated, e.g., 80, 443):</label>
                    <input type="text" id="ports-open-${nodeNumber}" name="ports-open-${nodeNumber}[]" placeholder="Enter ports here">
                </div>
            `;

            const containersNode = document.getElementById(`containers-node-${nodeNumber}`);
            containersNode.appendChild(containerSection);
        }

        function removeContainerSection(element, nodeNumber) {
            element.closest('.container-section').remove();
            // Decrement container count for this node
            containerCounts[nodeNumber]--;

            // Update the numbering for all remaining containers in this node
            const containersNode = document.getElementById(`containers-node-${nodeNumber}`);
            const remainingContainers = containersNode.getElementsByClassName('container-section');
            for (let i = 0; i < remainingContainers.length; i++) {
                // Update the container number displayed in the UI
                const containerHeader = remainingContainers[i].querySelector('h4');
                if (containerHeader) {
                    containerHeader.textContent = `Container ${i + 1}`;
                }

                // Optionally, update IDs and related attributes if they are used elsewhere
                // This example assumes IDs and related attributes follow a specific pattern and updates them accordingly
                remainingContainers[i].id = `node-${nodeNumber}-container-${i + 1}`;
                const selectElements = remainingContainers[i].querySelectorAll('select, input[type="file"], input[type="text"]');
                selectElements.forEach(el => {
                    // Update IDs and names to reflect the new container number
                    const baseId = el.id.split('-').slice(0, -1).join('-'); // Remove the old number
                    el.id = `${baseId}-${i + 1}`;
                    el.setAttribute('name', `${el.getAttribute('name').split('[')[0]}[${i + 1}][]`);
                });
            }
        }
    </script>
{% endblock %}